<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="asset/css/bootstrap.css" />
  <title>Chat</title>
  <style>
    input {
      display: block;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Chat Room</h1>
    <div class="card">
      <div class="card-body">
        <div id="messages" class="list-group">
        </div>
      </div>
    </div>
    <form id="chatbox" role="form">
      <div class="form-group">
        <label for="message">Send a message as {{.UserData.name}}</label> or
        <a href="/logout">Sign out</a>
        <textarea id="chatroom" cols="30" rows="10" class="form-control"></textarea>
        <input type="submit" value="Send" class="btn btn-primary" />
      </div>
    </form>
  </div>
  <script src="asset/js/jquery-3.6.0.js"></script>
  <script>
    $(window).on("load", function () {
      let socket = null
      let msgBox = $("#chatroom")
      let messages = $("#messages")
      $("#chatbox").on("submit", function (e) {
        e.preventDefault()
        if (!msgBox.val()) return false
        if (!socket) {
          alert("Error: there is no socket connection.");
          return false;
        }
        socket.send(JSON.stringify({
          Message: msgBox.val()
        }));
        msgBox.val("")
        return false;
      })
      if (!window["WebSocket"]) {
        alert("Error: your browser does not support web sockets.");
      } else {
        socket = new WebSocket("ws://{{.Host}}/room");
        socket.onclose = function () {
          alert("connection has been closed");
        };
        socket.onmessage = function (e) {
          let data = JSON.parse(e.data);

          let nameAndSaidTime = $("<div></div>").addClass("d-flex").addClass("w-100").addClass(
            "justify-content-between")
          let name = $("<h5></h5>").addClass("mb-1").append(data.Name)
          let saidTime = $("<small></small>").append("3 seconds ago")
          nameAndSaidTime.append(name).append(saidTime)
          let tail = $("<small></small>").append("And some small print.")
          let message = $("<p></p>").append(data.Message)
          let avatar = $("<img />").addClass("img-thumbnail").attr("src", data.AvatarURL).attr("alt", "avatar")
          let saidUnit = $("<a></a>").addClass("list-group-item list-group-item-action").attr("href", "#").attr(
            "aria-current", "true")
          saidUnit.append(nameAndSaidTime).append(message).append(tail)
          messages.append(saidUnit);
          // let li = document.createElement("li");
          // let img = document.createElement("img");
          // let strong = document.createElement("strong");
          // let span = document.createElement("span");
          // img.style.cssText = "width: 50; verticalAlign: 'middle'";
          // img.setAttribute("src", data.AvatarURL);
          // span.innerText = data.Message;
          // li.appendChild(img);
          // li.appendChild(span);
        };
      }
    })
  </script>
</body>

</html>